# 10.1 도커 컴포즈로 여러 개의 애플리케이션 배포하기

도커 컴포즈는 여러 개의 컨테이너로 구성된 애플리케이션을 단일 도커 엔진 호스트에서 실행하기 위한 도구이며, 개발자에게 특히 유용하므로 개발 환경이나 테스트 환경에서 주로 쓰인다. 조직에서는 같은 애플리케이션을 버전을 달리해 서로 다른 환경에서 구동해야 하는 경우가 있다. 이를테면 1.5 버전은 운영 환경에서, 1.5.1 버전은 핫픽스 테스트 환경에서, 1.6 버전은 사용자 테스트 환경에서, 1.7 버전은 시스템 테스트 환경에서 구동하는 식이다. 비운영 환경에서는 스케일링 기능이 필요 없으며 운영 환경만큼의 성능을 요구하지도 않는다. 그러므로 이들 비운영 환경이야 말로 도커 컴포즈가 가장 크게 활약할 수 있는 환경이다.

이렇게 여러 환경을 구성해 용도별로 사용하려면, 환경마다 애플리케이션이 다르게 동작하게끔 해야 한다. 무턱대고 여러 컨테이너가 같은 포트를 통해 요청을 받게 하거나, 서버에 있는 같은 파일을 여러 컨테이너가 쓰려고 해서는 안 된다. 이런 것이 가능하려면 도커 컴포즈 파일에서 이런 기능을 지원하게 해야 한다. 그 전에 먼저 도커 컴포즈가 어떤 도커 리소스가 애플리케이션의 일부인지 아닌지 판단하는 원리를 먼저 고려해야 하는데, 그 기준은 레이블의 명명 규칙을 따른다. 그러므로 같은 애플리케이션을 여러 번 실행하고 싶다면 이 기본값을 조금 수정해야 한다.

```c
hee@yuhuijin-ui-MacBookAir 080258 % cd ch10/exercises 
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./numbers/docker-compose.yml up -d
[+] Running 3/3
 ⠿ Network numbers_app-net          Created                                                                                                                                                                           0.1s
 ⠿ Container numbers-numbers-web-1  Started                                                                                                                                                                           0.5s
 ⠿ Container numbers-numbers-api-1  Started                                                                                                                                                                           0.5s
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose.yml up -d
[+] Running 2/2
 ⠿ Network todo-list_app-net       Created                                                                                                                                                                            0.0s
 ⠿ Container todo-list-todo-web-1  Started                                                                                                                                                                            0.4s
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose.yml up -d
[+] Running 1/0
 ⠿ Container todo-list-todo-web-1  Running     // 이미 실행중       
```

서로 다른 디렉터리에 있는 컴포즈 파일로부터 애플리케이션을 실행할 수는 있었지만, 이미 같은 디렉터리에서 실행한 애플리케이션을 하나 더 실행하려고 하니 잘 되지 않았다.

**도커 컴포즈는 도커 리소스가 어떤 애플리케이션의 일부인지 아닌지를 판정하기 위해 프로젝트(project)라는 개념을 사용한다.** **프로젝트 이름의 기본값은 도커 컴포즈 파일이 들어 있던 디렉터리명**인데, 도커 컴포즈가 도커 리소스를 만들 때 이 프로젝트 이름을 리소스의 이름에 접두사로 붙이고, 컨테이너 이름에는 번호를 접미사로 붙인다. 컨테이너 이름 뒤에는 번호가 붙기 때문에 스케일링에도 대응할 수 있다. 만약 서비스 web의 컨테이너를 두 개로 늘렸다면 새로 추가되는 컨테이너의 이름은 app1_web_2가 된다.

컴포즈가 사용하는 프로젝트 이름의 기본값을 바꿀 수 있으므로 이 프로젝트 이름을 바꾸는 방법으로 단일 도커 호스트에 같은 애플리케이션을 여러 번 실행시킬 수 있다.

```c
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose.yml -p todo-test up -d
[+] Running 2/2
 ⠿ Network todo-test_app-net       Created                                                                                                                                                                            0.0s
 ⠿ Container todo-test-todo-web-1  Started                                                                                                                                                                            0.4s
hee@yuhuijin-ui-MacBookAir exercises % docker container ls
CONTAINER ID   IMAGE                          COMMAND                   CREATED          STATUS                   PORTS                    NAMES
cf545fa7df0f   diamol/ch06-todo-list          "dotnet ToDoList.dll"     10 seconds ago   Up 9 seconds             0.0.0.0:62343->80/tcp    todo-test-todo-web-1
f2f1de265e1a   diamol/ch06-todo-list          "dotnet ToDoList.dll"     7 minutes ago    Up 7 minutes             0.0.0.0:62330->80/tcp    todo-list-todo-web-1
373aefa5ecb5   diamol/ch08-numbers-api:v3     "dotnet Numbers.Api.…"    7 minutes ago    Up 7 minutes (healthy)   80/tcp                   numbers-numbers-api-1
e274334da2b1   diamol/ch09-image-gallery      "/web/server"             37 minutes ago   Up 36 minutes            0.0.0.0:8010->80/tcp     exercises-image-gallery-1
12f9d795ab89   diamol/ch09-prometheus         "/bin/sh -c 'echo \"$…"   37 minutes ago   Up 36 minutes            0.0.0.0:9090->9090/tcp   exercises-prometheus-1
9cd2d7763051   diamol/ch09-access-log         "docker-entrypoint.s…"    37 minutes ago   Up 36 minutes            0.0.0.0:8012->80/tcp     exercises-accesslog-1
dd13ab572310   diamol/ch09-image-of-the-day   "java -jar /app/iotd…"    37 minutes ago   Up 36 minutes            0.0.0.0:8011->80/tcp     exercises-iotd-1
hee@yuhuijin-ui-MacBookAir exercises % docker container port todo-test-todo-web-1 80
0.0.0.0:62343
```

프로젝트 이름을 따로 지정해 주었기 때문에 컴포즈의 입장에서 이 애플리케이션은 기존에 실행 중인 것과 별개가 된다. 또 새로운 프로젝트 이름과 일치되는 리소스가 없기 때문에 새로운 컨테이너를 실행하게 된다. 명명 규칙을 이미 파악했으므로 새로운 컨테이너의 이름은 todo-test-todo-web-1이 되리라 예상할 수 있다. 도커 명령행에서 `container port` 부명령을 사용하면 컨테이너의 공개된 포트를 알려주므로 컨테이너 이름으로 애플리케이션의 포트도 알 수 있다.

이 방법으로 도커 컴포즈를 사용해 같은 애플리케이션도 여러 벌 실행할 수 있다. 무작위 숫자 애플리케이션도 하나의 컴포즈 파일로 프로젝트 이름만 바꿔 여러 벌 실행할 수 있다. 이정도로도 충분히 유용하지만 약간 아쉬운 점이 있다. 무작위로 정해진 공개 포트를 일일이 찾아야하는 것은 바람직한 일이 아니다. 컴포즈가 제공하는 기능 중에 더 좋은 방법이 있다. 설정을 오버 라이드하는 것이다.

# 10.2 도커 컴포즈의 오버라이드 파일

하나의 애플리케이션을 여러 설정으로 실행해야 할 필요가 생긴 경우 대부분은 컴포즈 파일을 각 설정 또는 환경마다 하나씩 여러 개 두는 방법을 쓴다. 그러나 이 방법은 유지 보수 측면에서 바람직하지 않다. 이들 컴포즈 파일의 내용은 90% 이상이 중복이니 수정 시 누락이 발생한다면 환경 차이 문제가 되살아나게 된다. 오버라이드 파일은 이런 문제를 해결하는 기능이다. **도커 컴포즈는 여러 파일을 합쳐 컴포즈 파일을 구성하는데, 나중에 지정된 파일의 내용이 이전 파일의 내용을 오버라이드, 즉 덮어 쓰기 한다.**

먼저 기본적인 애플리케이션 구조와 모든 환경에서 공통으로 쓰이는 속성이 정의된 docker-compose.yml 파일이 있고, 환경별로 작성된 오버라이드 파일이 해당 환경에서 달라진 속성을 정의한다. 하지만 이들 파일의 내용은 기본 파일과 항목이 중복되지 않는다.

이렇게 구성하면 설정 파일에 중복된 내용이 없고 유지 보수성이 개선된다. 모든 환경에 공통적으로 적용될 내용(이를테면, 이미지 태그를 최신 버전으로 변경)을 변경하고 싶다면 기본 파일을 수정하면 된다. 어느 특정 환경에만 적용하고 싶은 변경 내용이라면 해당 환경의 오버라이드 파일만 수정한다. 오버라이드 파일에는 각 환경의 차이점만 정리돼 있을 것이므로 그 자체로 문서 역할을 할 수도 있다.

오버라이드 파일에는 해당 환경에서 변경할 항목만 기술하면 된다, 그러나 기본 컴포즈 파일의 구조를 유지해야 도커 컴포즈가 두 정의를 연결 지을 수 있다. **이 예제의 오버라이드 파일은 image 속성값 하나만 변경하는데, 이 속성은 기본 파일상의 위치와 마찬가지로 services 블록의 todo-web 블록 아래에 위치한다.**

도커 컴포즈는 하나 이상의 파일이 인자로 지정됐을 때 이들 파일을 병합한다. 특히 `config` 부명령이 이때 유용한데, 이 부명령은 **입력 파일의 내용을 검증해 내용이 유효한 경우에만 최종 출력을 내놓는다. 이 최종 출력이 실제 반영되는 컴포즈 파일이 되므로 오버라이드 파일을 적용한 결과를 예상할 수 있다.**

```yaml
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose.yml -f ./todo-list/docker-compose-v2.yml config
name: todo-list
services:
  todo-web:
    environment:
      Database:Provider: Sqlite
    image: diamol/ch06-todo-list:v2
    networks:
      app-net: null
    ports:
    - mode: ingress
      target: 80
      protocol: tcp
networks:
  app-net:
    name: todo-list_app-net
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose-v2.yml -f ./todo-list/docker-compose.yml config
name: todo-list
services:
  todo-web:
    environment:
      Database:Provider: Sqlite
    image: diamol/ch06-todo-list
    networks:
      app-net: null
    ports:
    - mode: ingress
      target: 80
      protocol: tcp
networks:
  app-net:
    name: todo-list_app-net
```

`config` 부명령은 설정 파일의 내용이 유효한지 확인할 뿐 애플리케이션을 실제로 실행하지는 않는다. 대신 기본 파일과 오버라이드 파일이 병합된 컴포즈 파일을 미리 볼 수 있다.

도커 컴포즈가 오버라이드 파일을 병합하는 순서는 인자로 받은 순서를 따른다. 다시 말해, 인자로 지정된 순서가 먼저인 파일이 순서가 나중인 파일보다 우선한다. 파일의 순서를 잘못 나열하면 원치 않은 결과를 얻을 수 있다. `config` 부명령은 병합된 컴포즈 파일의 결과를 미리 알 수 있다는 점에서 유용하다. 병합된 파일의 내용을 보면 모든 속성이 알파벳 순으로 정렬돼 있다. 알파벳 순서로 컴포즈 파일의 구조가 고정되기 때문에 서로 다른 버전을 비교하기에 유리하다.

오버라이드 파일에서 이미지 태그를 수정한 것은 이해를 위한 아주 간단한 예로, numbers 디렉터리에 오버라이드 파일 실전 응용 사례가 있는데 이 도커 컴포즈 파일은 다음과 같이 구성된다.

- docker-compose.yml: 기본 컴포즈 파일, 웹 및 API 서비스가 정의됐으나 포트나 도커 네트워크에 대한 정의는 빠져 있다.
- docker-compose-dev.yml: 개발 환경 대상의 설정, 도커 네트워크 및 서비스의 공개 포트를 정의하고 헬스 체크와 디펜던시 체크를 비활성화 한다. 개발자들이 빠르게 애플리케이션을 실행하는 것을 목적으로 한다.
- docker-compose-test.yml: 테스트 환경 대상의 설정. 도커 네트워크를 정의하고, 헬스 체크를 설정하고, 웹 서비스의 공개 포트를 정의한다. 그러나 API 서비스의 포트는 공개하지 않는다.
- docker-compose-uat.yml: 사용자 인수 테스트 환경 대상의 설정. 도커 네트워크를 설정하고, 웹 서비스는 80번 표준 포트로 공개하고, 서비스가 오류 발생 시 항상 재시작하도록 설정하고, 헬스 체크를 좀 더 꼼꼼하게 하도록 지정한다.

예제 10-2는 개발 환경 대상의 오버라이드 파일이다. 한 눈에 봐도 이미지가 지정돼 있지 않기 때문에 애플리케이션의 전체 구성을 담은 것이 아니라는 점을 알 수 있다. 이 파일에 정의된 속성값은 기본 컴포즈 파일에 병합돼 속성을 추가하거나 기존 속성의 값을 변경하는 역할을 한다. 다른 오버라이드 파일도 동일한 구조를 따른다. 환경마다 웹 애플리케이션과 API가 사용하는 포트가 다르기 때문에 여러 개의 애플리케이션을 단일 도커 호스트에서 실행할 수 있다.

```yaml
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./numbers/docker-compose.yml -f ./numbers/docker-compose-dev.yml -p numbers-dev up -d
[+] Running 13/13
 ⠿ numbers-web Pulled                                                                                                                                 6.7s
   ⠿ 2c6f18abfee2 Pull complete                                                                                                                       2.0s
   ⠿ c8933103e3d5 Pull complete                                                                                                                       2.2s
   ⠿ fae779850b6e Pull complete                                                                                                                       3.0s
 ⠿ numbers-api Pulled                                                                                                                                 5.1s
   ⠿ f338bc35613f Already exists                                                                                                                      0.0s
   ⠿ 5636d912c69e Already exists                                                                                                                      0.0s
   ⠿ 362df8b85fca Already exists                                                                                                                      0.0s
   ⠿ 24c3992ceef4 Already exists                                                                                                                      0.0s
   ⠿ 546a81dfea0f Already exists                                                                                                                      0.0s
   ⠿ a1d31c83c9fb Pull complete                                                                                                                       1.4s
   ⠿ b4b21f2c15f2 Pull complete                                                                                                                       1.5s
   ⠿ 5b2370cbc2a2 Pull complete                                                                                                                       1.5s
[+] Running 3/3
 ⠿ Network numbers-dev                  Created                                                                                                       0.0s
 ⠿ Container numbers-dev-numbers-web-1  Started                                                                                                       0.3s
 ⠿ Container numbers-dev-numbers-api-1  Started                                                                                                       0.3s
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./numbers/docker-compose.yml -f ./numbers/docker-compose-test.yml -p numbers-test up -d
[+] Running 3/3
 ⠿ Network numbers-test                  Created                                                                                                      0.0s
 ⠿ Container numbers-test-numbers-web-1  Started                                                                                                      0.3s
 ⠿ Container numbers-test-numbers-api-1  Started                                                                                                      0.3s
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./numbers/docker-compose.yml -f ./numbers/docker-compose-uat.yml -p numbers-uat up -d 
[+] Running 3/3
 ⠿ Network numbers-uat                  Created                                                                                                       0.0s
 ⠿ Container numbers-uat-numbers-web-1  Started                                                                                                       0.4s
 ⠿ Container numbers-uat-numbers-api-1  Started   
 
 hee@yuhuijin-ui-MacBookAir exercises % docker ps
CONTAINER ID   IMAGE                        COMMAND                  CREATED              STATUS                          PORTS                  NAMES
929206d8c4d4   diamol/ch08-numbers-web:v3   "/bin/sh -c 'dotnet …"   About a minute ago   Up About a minute               0.0.0.0:80->80/tcp     numbers-uat-numbers-web-1
77668f4e28cf   diamol/ch08-numbers-api:v3   "dotnet Numbers.Api.…"   About a minute ago   Up About a minute (healthy)     0.0.0.0:8090->80/tcp   numbers-uat-numbers-api-1
4af4ec0e5e93   diamol/ch08-numbers-api:v3   "dotnet Numbers.Api.…"   About a minute ago   Up About a minute (unhealthy)   80/tcp                 numbers-test-numbers-api-1
7e2d2b95a00c   diamol/ch08-numbers-web:v3   "/bin/sh -c 'dotnet …"   About a minute ago   Restarting (1) 16 seconds ago                          numbers-test-numbers-web-1
43cfa01a9b31   diamol/ch08-numbers-api:v3   "dotnet Numbers.Api.…"   2 minutes ago        Up 2 minutes                    0.0.0.0:8087->80/tcp   numbers-dev-numbers-api-1
9f7f75627ce8   diamol/ch08-numbers-web:v3   "dotnet Numbers.Web.…"   2 minutes ago        Up 2 minutes                    0.0.0.0:8088->80/tcp   numbers-dev-numbers-web-1      
```

애플리케이션 세 개를 실행 중이며, 이들 각각은 모두 별개의 도커 네트워크를 사용하므로 서로 독립적이다. 개발 팀에서는 이들 모두를 한 서버에서 실행하고, 팀마다 포트를 달리해 자신의 업무와 관련된 환경에 접근할 수 있다.

이들 환경별로 실행된 컨테이너는 도메인 네임을 사용해 서로를 식별하지만, 같은 도커 네트워크에 접속한 컨테이너끼리만 통신이 가능하다.

다시 한 번 강조하지만, 도커 컴포즈는 클라이언트에서 동작하는 도구다. 그러므로 애플리케이션을 관리하려면 컴포즈 파일에 접근이 가능해야 하며, 애플리케이션을 실행할 때 지정한 프로젝트 이름도 알고 있어야 한다. 테스트 환경의 애플리케이션을 종료하려면 해당 환경의 컨테이너와 네트워크를 제거해야 한다. 일반적인 상황이라면 `docker-compose down` 명령을 실행하면 되겠지만, **프로젝트 이름을 기본값에서 변경한 지금은 `docker-compose up` 명령을 실행할 때 사용한 모든 파일과 프로젝트 정보를 정확히 지정해야 한다.**

```yaml
hee@yuhuijin-ui-MacBookAir exercises % docker-compose down
no configuration file provided: not found
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./numbers/docker-compose.yml -f ./numbers/docker-compose-test.yml down
[+] Running 0/0
 ⠿ Network numbers-test  Error                                                                                                                        0.0s
failed to remove network numbers-test: Error response from daemon: error while removing network: network numbers-test id af4d297769c2a27130d7b9bb4dde305653827239082aa9c3b23659b55be9eec1 has active endpoints
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./numbers/docker-compose.yml -f ./numbers/docker-compose-test.yml -p numbers-test down
[+] Running 3/3
 ⠿ Container numbers-test-numbers-web-1  Removed                                                                                                      0.0s
 ⠿ Container numbers-test-numbers-api-1  Removed                                                                                                      0.1s
 ⠿ Network numbers-test                  Removed   
```

이러한 오류는 컴포즈 오버라이드 파일에 네트워크의 이름이 명시적으로 지정됐기 때문이다. 두 번째로 실행한 `down` 명령에 프로젝트 이름을 따로 지정하지 않았으므로 기본값인 `numbers` 가 사용됐으며, 컴포즈는 이 프로젝트 이름을 따라 `numbers_numbers-web-1` 과 `numbers_numbers-api_1` 이라는 이름의 컨테이너를 찾는다. 그러나 애플리케이션을 실행할 때는 `numbers-test`라는 프로젝트 이름을 사용했으니 앞서 언급한 이름의 컨테이너는 생성된 적이 없다. 따라서 컴포즈는 해당 컨테이너가 이미 제거됐다고 판단하고, 프로젝트 이름이 붙지 않고 명시적으로 이름이 지정된 네트워크를 찾아내 이를 제거하려고 시도한다. 하지만 이 네트워크에는 아직 연결된 컨테이너가 있기 때문에 네트워크도 제거할 수 없다.

# 10.3 환경 변수와 비밀값을 이용해 설정 주입하기

```yaml
services:
  todo-web:
    image: diamol/ch06-todo-list
    secrets:
      - source: todo-db-connection
        target: /app/config/secrets.json
```

비밀값은 도커 컴포즈, 도커 스웜, 쿠버네티스에서 모두 지원하는 기능으로, 설정값을 주입하기에 매우 유용한 기능이다. 컴포즈 파일에서 비밀값의 원본 위치와 대상 위치를 모두 지정할 수 있는데, **원본 위치는 컨테이너 런타임이 비밀값의 값을 읽어오는 곳이고 대상 위치는 컨테이너 안에서 비밀값이 위치할 경로를 의미한다.**

이 컴포즈 파일에 사용된 비밀값은 todo-db-connection에서 읽어 오도록 되어 있는데, 이 값을 읽으려면 이 이름으로 정의된 비밀값이 해당 컴포즈 파일에 정의돼 있어야 한다. 그리고 비밀값의 내용은 컨테이너 속 경로 /app/config/secrets.json 파일로 전달된다. 이 경로는 애플리케이션이 설정 파일을 찾는 경로이기도 하다.

```yaml
services:
  todo-web:
    ports:
      - 8089:80
    environment:
      - Database:Provide=Sqlite
    env_file:
      - ./config/logging.debug.env

secrets:
  todo-db-connection:
    file: ./config/empty.json
```

앞서 본 컴포즈 파일은 스크립트에서 사용된 `todo-db-connection` 비밀값이 해당 파일에 정의돼 있지 않기 때문에 단독으로 사용하면 유효하지 않다. 

이 오버라이드 파일에는 세 가지 프로퍼티가 정의돼 있다. 이들 프로퍼티는 애플리케이션에 설정값을 주입해 동작을 변화시키는 역할을 한다. 셋 중에 원하는 것만 골라 적용해도 되지만 이들 모두 나름의 장점이 있다.

- `environment` 프로퍼티는 컨테이너 안에서만 사용되는 환경 변수를 추가한다. 이 환경 변수 값을 적용하면 애플리케이션이 데이터베이스 파일 데이터베이스인 SQLite를 사용한다. 설정값을 전달하는 방법 중 가장 간단한 방법이다.
- `env_file` 프로퍼티는 텍스트 파일의 경로를 값으로 받는다. 이 파일에 정의된 환경 변수가 컨테이너에 적용된다. 텍스트 파일에 변수 이름과 값을 등호로 구분해 한 줄에 하나씩 정의한다. 같은 환경 변수를 여러 번 정의하지 않아도 환경 변수를 여러 컴포넌트에서 공유해 사용할 수 있다.
- `secrets` 프로퍼티는 `services`나 `networks`처럼 컴포즈 파일의 최상위 프로퍼티이며, 이 프로퍼티의 `todo-db-connection`의 실제 값 혹은 경로가 정의된다. (여기서는 로컬 파일 시스템 상의 파일로 정의됐다.) 이 예제에는 별도의 데이터베이스가 없으므로 빈 JSON 파일을 사용했다. 애플리케이션이 파일을 읽어도 추가로 적용되는 설정값은 없다.

```yaml
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list-configured/docker-compose.yml -f ./todo-list-configured/docker-compose-dev.yml -p todo-dev up -d
[+] Running 8/8
 ⠿ todo-web Pulled                                                                                                                                    7.4s
   ⠿ f338bc35613f Already exists                                                                                                                      0.0s
   ⠿ 5636d912c69e Already exists                                                                                                                      0.0s
   ⠿ 362df8b85fca Already exists                                                                                                                      0.0s
   ⠿ 24c3992ceef4 Already exists                                                                                                                      0.0s
   ⠿ 546a81dfea0f Already exists                                                                                                                      0.0s
   ⠿ 3e6d6e6fdcce Pull complete                                                                                                                       1.2s
   ⠿ 697b28c7a381 Pull complete                                                                                                                       4.1s
[+] Running 2/2
 ⠿ Network todo-dev_default       Created                                                                                                             0.0s
 ⠿ Container todo-dev-todo-web-1  Started                                                                                                             0.3s
hee@yuhuijin-ui-MacBookAir exercises % curl http://localhost:8089/list

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DIAMOL To-Do List</title>
    <base href="/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link href="css/site.css" rel="stylesheet" />
</head>
<body>
    <app>
        <!--Blazor:{"sequence":0,"type":"server","prerenderId":"6db0921b408448579c2ff1d4d62dbba3","descriptor":"CfDJ8Ixy8Kso7JRJvaOUfW2BT2V9Qfrbtf3c9o-ac_KqcCfi-AOu6AbVUk8KTACD97gjvl56oOrEqryK8CGGa-VnFpZHpa5cCuu6dj1kOnc_JYlp7uydj9nNfbIwYwIH1WapYawyzmY2UmAwnXYkl7Z6o3UNdRIR43MBohomht66TA5nSOyoHqX3BR9lw8iTB9bX4Sd9p1SJNzZPeGf0e6C3XRvRqariy_jfvpWi7TDKMGy8Ap2uQwqzwbp08w-SWBY41ZycxzuJWDJyvn5-6xrc1lNXZ90PWNtwEbbpThr3hfNi"}-->
        <div class="sidebar">
    <div class="top-row pl-4 navbar navbar-dark">
    <a class="navbar-brand" href>DIAMOL To-Do List</a>
    <button class="navbar-toggler">
        <span class="navbar-toggler-icon"></span>
    </button>
</div>

<div class="collapse">
    <ul class="nav flex-column">
        <li class="nav-item px-3">
            <a href="" class="nav-link">
                <span class="oi oi-home" aria-hidden="true"></span> Home
            </a>
        </li>
        <li class="nav-item px-3">
            <a href="new" class="nav-link">
                <span class="oi oi-plus" aria-hidden="true"></span> New item
            </a>
        </li>
        <li class="nav-item px-3">
            <a href="list" class="nav-link active">
                <span class="oi oi-list-rich" aria-hidden="true"></span> To-do list
            </a>
        </li>
        <li class="nav-item px-3">
            <a href="diagnostics" class="nav-link">
                <span class="oi oi-cog" aria-hidden="true"></span> Diagnostics
            </a>
        </li>
    </ul>
</div>
</div>

<div class="main">
    <div class="top-row px-4">
        <a href="https://github.com/sixeyed/diamol/tree/master/ch06/exercises/todo-list" target="_blank">Source Code</a>
    </div>

    <div class="content px-4">
        <h1>TODO List</h1>

<p>There is much still to do.</p>

<p>But there's always room to <a href="/new">add more</a>.</p>

<table class="table">
    <thead>
        <tr>
            <th>Item</th>
            <th>Date Added</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

    </div>
</div>
    <!--Blazor:{"prerenderId":"6db0921b408448579c2ff1d4d62dbba3"}-->
    </app>

    <script src="_framework/blazor.server.js"></script>
</body>
</html>
hee@yuhuijin-ui-MacBookAir exercises % docker container logs --tail 4 todo-dev-todo-web-1
dbug: Microsoft.AspNetCore.Server.Kestrel[10]
      Connection id "0HNJE41V7DRPF" disconnecting.
dbug: Microsoft.AspNetCore.Server.Kestrel[2]
      Connection id "0HNJE41V7DRPF" stopped.
```

도커 컴포즈는 애플리케이션 한 개마다 도커 네트워크를 하나씩 사용하므로 컴포즈 파일에 정의된 네트워크가 없어도 기본 네트워크에 컨테이너를 연결한다.

개발 환경에는 비밀값과 환경 변수로 설정값을 주입하며, 이 비밀값과 환경 변수는 컴포즈 파일과 컴포즈 파일에 지정된 경로에 있는 설정 파일로부터 읽어 오는 방법을 사용했다.

테스트 환경에서는 컴포즈가 제공하는 다른 방법을 통해 설정값을 주입해보겠다. 호스트 컴퓨터의 환경 변수 값을 컨테이너에 전달하는 방법이다. 이 방법을 사용하면 컴포즈 파일을 수정하지 않아도 설정값을 변경할 수 있기 때문에 애플리케이션의 이식성이 향상된다. 다른 컴퓨터에서 환경 변수 값만 바꾸면 설정이 다른 테스트 환경을 하나 더 꾸릴 수 있기 때문에 편리하다.

달러 기호가 붙은 중괄호 부분이 괄호 안에 적인 이름의 환경 변수 값으로 치환된다. 만약 내가 도커 컴포즈를 실행중인 컴퓨터의 환경 변수 `TODO_WEB_PORT`의 값이 8877이었다면 `ports` 프로퍼티의 값이 `"8877:80"`이 된다.

테스트 환경 역시 환경별 컴포즈 파일 이름과 프로젝트 이름을 지정해 주면 애플리케이션을 실행할 수 있다. 하지만 마지막으로 소개할 컴포즈의 더 편리한 설정 기능을 추가로 적용해 보겠다. **컴포즈로 애플리케이션을 실행할 때 대상 디렉터리에서 `.env` 파일을 발견하면, 이 파일을 환경 파일로 간주하고 파일의 내용으로부터 환경 변수를 읽어들여 애플리케이션을 실행하기 전에 먼저 적용한다.**

이 환경 파일에는 테스트 환경을 위한 애플리케이션 설정이 기본값으로 들어 있으며, 파일명만 바꾸면 쉽게 개발 환경 설정을 기본값으로 할 수 있다. 컴포즈 파일과 함께 환경 파일을 잘 관리하면 어떤 파일이 어떤 환경의 설정값에 해당하는지에 대한 문서 역할을 대신할 수 있으나 주의할 점이 있다. **도커 컴포즈는 .`env` 파일만을 환경 파일로 간주하기 때문에 환경 파일 여러 개를 만들어 바꿔가면서 사용할 수 없다.**

- `environment` 프로퍼티를 사용해 환경 변수를 지정하는 방법은 간단하고 컴포즈 파일의 가독성도 좋다. 그러나 평문 텍스트로 작성되기 때문에 API 키나 데이터베이스 접속 정보 같은 민감한 정보에는 사용하지 않는 편이 좋다.
- 비밀값에 설정값을 지정하는 방법은 모든 컨테이너 런타임에서 적용 가능하고 민감한 정보가 유출될 우려도 없기 때문에 유연성 면에서 가장 뛰어나다. 비밀값의 실제 값은 로컬 파일 시스템에 저장할 수도 있고 도커 스웜이나 쿠버네티스 클러스터에 저장할 수도 있다. 실제 값이 어디에 저장되든 애플리케이션이 실행될 때 컨테이너 속의 특정한 파일로 전달된다.
- 설정값을 파일에 저장한 다음 이 파일의 경로를 `environment_file` 프로퍼티에 지정하는 방법은 서비스 간에 공유하는 설정이 많은 경우에 유용하다. 컴포즈가 로컬에 위치한 파일을 읽어 각 설정값을 지정해주기 때문에 원격 컴퓨터에서 실행중인 도커 엔진을 다룰 때도 로컬 컴퓨터의 설정값을 적용할 수 있다.
- 환경 파일 .env는 환경을 막론하고 기본 설정을 지정할 때 유용하다.

# 10.4 확장 필드로 중복 제거하기

확장 필드는 YAML의 여러 블록을 한 곳에서 정의하는 기능이다. 컴포즈 파일에서는 스크립트 전체에 걸쳐 이 블록을 재사용하는 효과를 얻을 수 있다. 확장 필드는 컴포즈의 강력한 기능 중 하나이지만 그리 널리 쓰이는 기능은 아니다. 확장 필드는 스크립트의 중복을 제거하는 동시에 잠재적인 오류를 줄여준다. 또한, YAML 병합 문법에 익숙하다면 직관적으로 사용할 수 있다.

```yaml
x-labels: &logging
  logging:  
    options:
      max-size: '100m'
      max-file: '10'

x-labels: &labels
  app-name: image-gallery
```

최상위 블록 외부 (services, networks 등)라면 어디서든 정의할 수 있으며, 이름에 앰퍼샌드 문법을 사용한다.

확장 필드는 일종의 사용자 정의 필드다. 위 파일을 보면 `logging`과 `labels`라는 두개의 확장 필드가 있다. 블록은 관습적으로 x로 시작하는 이름을 붙인다. 그러므로 `x-labels`블록은 `labels` 블록의 확장 필드가 된다. `logging` 확장 필드는 컨테이너 로그를 위한 설정을 포함하므로 서비스 정의에 이 블록을 사용할 수 있다. 그리고 `labels` 확장 필드는 레이블로 사용할 키-값 쌍을 정의하는데, 이 블록은 서비스 정의의 `labels` 필드에서 사용할 수 있다.

두 정의의 차이를 눈여겨보기 바란다. `logging` 필드는 `logging` 프로퍼티를 포함하므로 이 블록을 서비스에서 바로 사용할 수 있다. 그러나 `labels` 필드는 `labels` 프로퍼티를 포함하지 않기 때문에 기존 `labels` 필드 안에서 사용돼야 한다.

```yaml
services:
  accesslog:
    <<: *logging
    labels:
      <<: *labels

  iotd:
    ports:
      - 8080:80
    <<: *logging
    labels:
      <<: *labels
      public: api
```

[docker-compose Extension fields 알아보기](https://ujuc.github.io/2021/07/15/docker-compose-extension-fields-%EC%95%8C%EC%95%84%EB%B3%B4%EA%B8%B0/)

확장 필드를 재사용할 때는 YAML 병합 문법을 사용해 `<<:*필드명` 과 같이 쓴다. 그러므로 `<<:*logging` 위치에 해당 YAML 파일의 `logging` 확장 필드값이 병합된다. 컴포즈가 이 파일을 처리하고 나면 서비스의 `logging` 에 `logging` 확장 필드의 값이 들어가고, `labels`에 `labels` 확장 필드에 정의된 레이블이 추가된다.

```yaml
hee@yuhuijin-ui-MacBookAir image-gallery % docker-compose -f ./docker-compose.yml -f ./docker-compose-prod.yml config
WARN[0000] The "HOST_IP" variable is not set. Defaulting to a blank string. 
name: image-gallery
services:
  accesslog:
    image: diamol/ch09-access-log
    labels:
      app-name: image-gallery
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
  grafana:
    depends_on:
      prometheus:
        condition: service_started
    image: diamol/ch09-grafana
    labels:
      app-name: image-gallery
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
    ports:
    - mode: ingress
      target: 3000
      published: "3000"
      protocol: tcp
  image-gallery:
    image: diamol/ch09-image-gallery
    labels:
      app-name: image-gallery
      public: web
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
    ports:
    - mode: ingress
      target: 80
      published: "80"
      protocol: tcp
  iotd:
    image: diamol/ch09-image-of-the-day
    labels:
      app-name: image-gallery
      public: api
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
    ports:
    - mode: ingress
      target: 80
      published: "8080"
      protocol: tcp
  prometheus:
    environment:
      DOCKER_HOST: ""
    image: diamol/ch09-prometheus
    labels:
      app-name: image-gallery
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
    ports:
    - mode: ingress
      target: 9090
      published: "9090"
      protocol: tcp
networks:
  app-net:
    name: image-gallery-prod
x-labels:
  app-name: image-gallery
```

확장 필드는 컴포즈 파일을 관리하는 베스트 프랙티스 중 한 가지 방법이다. 특히 로깅 및 레이블 설정은 모든 서비스에 공통적으로 적용되는 경우가 많다. 모든 애플리케이션에서 활용되는 것은 아니지만 잘 익혀두면 중복이 많은 YAML 파일을 작성할 때 매우 유용하다. 하지만 **확장 필드에도 여러 컴포즈 파일에 한꺼번에 적용할 수 없다는 한계점이 있다. 이 때문에 코어 컴포즈 파일에 정의된 확장 필드를 오버라이드 필드에서 사용할 수는 없다.**