# 10.1 도커 컴포즈로 여러 개의 애플리케이션 배포하기

도커 컴포즈는 여러 개의 컨테이너로 구성된 애플리케이션을 단일 도커 엔진 호스트에서 실행하기 위한 도구이며, 개발자에게 특히 유용하므로 개발 환경이나 테스트 환경에서 주로 쓰인다. 조직에서는 같은 애플리케이션을 버전을 달리해 서로 다른 환경에서 구동해야 하는 경우가 있다. 이를테면 1.5 버전은 운영 환경에서, 1.5.1 버전은 핫픽스 테스트 환경에서, 1.6 버전은 사용자 테스트 환경에서, 1.7 버전은 시스템 테스트 환경에서 구동하는 식이다. 비운영 환경에서는 스케일링 기능이 필요 없으며 운영 환경만큼의 성능을 요구하지도 않는다. 그러므로 이들 비운영 환경이야 말로 도커 컴포즈가 가장 크게 활약할 수 있는 환경이다.

이렇게 여러 환경을 구성해 용도별로 사용하려면, 환경마다 애플리케이션이 다르게 동작하게끔 해야 한다. 무턱대고 여러 컨테이너가 같은 포트를 통해 요청을 받게 하거나, 서버에 있는 같은 파일을 여러 컨테이너가 쓰려고 해서는 안 된다. 이런 것이 가능하려면 도커 컴포즈 파일에서 이런 기능을 지원하게 해야 한다. 그 전에 먼저 도커 컴포즈가 어떤 도커 리소스가 애플리케이션의 일부인지 아닌지 판단하는 원리를 먼저 고려해야 하는데, 그 기준은 레이블의 명명 규칙을 따른다. 그러므로 같은 애플리케이션을 여러 번 실행하고 싶다면 이 기본값을 조금 수정해야 한다.

```c
hee@yuhuijin-ui-MacBookAir 080258 % cd ch10/exercises 
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./numbers/docker-compose.yml up -d
[+] Running 3/3
 ⠿ Network numbers_app-net          Created                                                                                                                                                                           0.1s
 ⠿ Container numbers-numbers-web-1  Started                                                                                                                                                                           0.5s
 ⠿ Container numbers-numbers-api-1  Started                                                                                                                                                                           0.5s
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose.yml up -d
[+] Running 2/2
 ⠿ Network todo-list_app-net       Created                                                                                                                                                                            0.0s
 ⠿ Container todo-list-todo-web-1  Started                                                                                                                                                                            0.4s
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose.yml up -d
[+] Running 1/0
 ⠿ Container todo-list-todo-web-1  Running     // 이미 실행중       
```

서로 다른 디렉터리에 있는 컴포즈 파일로부터 애플리케이션을 실행할 수는 있었지만, 이미 같은 디렉터리에서 실행한 애플리케이션을 하나 더 실행하려고 하니 잘 되지 않았다.

**도커 컴포즈는 도커 리소스가 어떤 애플리케이션의 일부인지 아닌지를 판정하기 위해 프로젝트(project)라는 개념을 사용한다.** **프로젝트 이름의 기본값은 도커 컴포즈 파일이 들어 있던 디렉터리명**인데, 도커 컴포즈가 도커 리소스를 만들 때 이 프로젝트 이름을 리소스의 이름에 접두사로 붙이고, 컨테이너 이름에는 번호를 접미사로 붙인다. 컨테이너 이름 뒤에는 번호가 붙기 때문에 스케일링에도 대응할 수 있다. 만약 서비스 web의 컨테이너를 두 개로 늘렸다면 새로 추가되는 컨테이너의 이름은 app1_web_2가 된다.

컴포즈가 사용하는 프로젝트 이름의 기본값을 바꿀 수 있으므로 이 프로젝트 이름을 바꾸는 방법으로 단일 도커 호스트에 같은 애플리케이션을 여러 번 실행시킬 수 있다.

```c
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose.yml -p todo-test up -d
[+] Running 2/2
 ⠿ Network todo-test_app-net       Created                                                                                                                                                                            0.0s
 ⠿ Container todo-test-todo-web-1  Started                                                                                                                                                                            0.4s
hee@yuhuijin-ui-MacBookAir exercises % docker container ls
CONTAINER ID   IMAGE                          COMMAND                   CREATED          STATUS                   PORTS                    NAMES
cf545fa7df0f   diamol/ch06-todo-list          "dotnet ToDoList.dll"     10 seconds ago   Up 9 seconds             0.0.0.0:62343->80/tcp    todo-test-todo-web-1
f2f1de265e1a   diamol/ch06-todo-list          "dotnet ToDoList.dll"     7 minutes ago    Up 7 minutes             0.0.0.0:62330->80/tcp    todo-list-todo-web-1
373aefa5ecb5   diamol/ch08-numbers-api:v3     "dotnet Numbers.Api.…"    7 minutes ago    Up 7 minutes (healthy)   80/tcp                   numbers-numbers-api-1
e274334da2b1   diamol/ch09-image-gallery      "/web/server"             37 minutes ago   Up 36 minutes            0.0.0.0:8010->80/tcp     exercises-image-gallery-1
12f9d795ab89   diamol/ch09-prometheus         "/bin/sh -c 'echo \"$…"   37 minutes ago   Up 36 minutes            0.0.0.0:9090->9090/tcp   exercises-prometheus-1
9cd2d7763051   diamol/ch09-access-log         "docker-entrypoint.s…"    37 minutes ago   Up 36 minutes            0.0.0.0:8012->80/tcp     exercises-accesslog-1
dd13ab572310   diamol/ch09-image-of-the-day   "java -jar /app/iotd…"    37 minutes ago   Up 36 minutes            0.0.0.0:8011->80/tcp     exercises-iotd-1
hee@yuhuijin-ui-MacBookAir exercises % docker container port todo-test-todo-web-1 80
0.0.0.0:62343
```

프로젝트 이름을 따로 지정해 주었기 때문에 컴포즈의 입장에서 이 애플리케이션은 기존에 실행 중인 것과 별개가 된다. 또 새로운 프로젝트 이름과 일치되는 리소스가 없기 때문에 새로운 컨테이너를 실행하게 된다. 명명 규칙을 이미 파악했으므로 새로운 컨테이너의 이름은 todo-test-todo-web-1이 되리라 예상할 수 있다. 도커 명령행에서 `container port` 부명령을 사용하면 컨테이너의 공개된 포트를 알려주므로 컨테이너 이름으로 애플리케이션의 포트도 알 수 있다.

이 방법으로 도커 컴포즈를 사용해 같은 애플리케이션도 여러 벌 실행할 수 있다. 무작위 숫자 애플리케이션도 하나의 컴포즈 파일로 프로젝트 이름만 바꿔 여러 벌 실행할 수 있다. 이정도로도 충분히 유용하지만 약간 아쉬운 점이 있다. 무작위로 정해진 공개 포트를 일일이 찾아야하는 것은 바람직한 일이 아니다. 컴포즈가 제공하는 기능 중에 더 좋은 방법이 있다. 설정을 오버 라이드하는 것이다.

# 10.2 도커 컴포즈의 오버라이드 파일

하나의 애플리케이션을 여러 설정으로 실행해야 할 필요가 생긴 경우 대부분은 컴포즈 파일을 각 설정 또는 환경마다 하나씩 여러 개 두는 방법을 쓴다. 그러나 이 방법은 유지 보수 측면에서 바람직하지 않다. 이들 컴포즈 파일의 내용은 90% 이상이 중복이니 수정 시 누락이 발생한다면 환경 차이 문제가 되살아나게 된다. 오버라이드 파일은 이런 문제를 해결하는 기능이다. **도커 컴포즈는 여러 파일을 합쳐 컴포즈 파일을 구성하는데, 나중에 지정된 파일의 내용이 이전 파일의 내용을 오버라이드, 즉 덮어 쓰기 한다.**

먼저 기본적인 애플리케이션 구조와 모든 환경에서 공통으로 쓰이는 속성이 정의된 docker-compose.yml 파일이 있고, 환경별로 작성된 오버라이드 파일이 해당 환경에서 달라진 속성을 정의한다. 하지만 이들 파일의 내용은 기본 파일과 항목이 중복되지 않는다.

이렇게 구성하면 설정 파일에 중복된 내용이 없고 유지 보수성이 개선된다. 모든 환경에 공통적으로 적용될 내용(이를테면, 이미지 태그를 최신 버전으로 변경)을 변경하고 싶다면 기본 파일을 수정하면 된다. 어느 특정 환경에만 적용하고 싶은 변경 내용이라면 해당 환경의 오버라이드 파일만 수정한다. 오버라이드 파일에는 각 환경의 차이점만 정리돼 있을 것이므로 그 자체로 문서 역할을 할 수도 있다.

오버라이드 파일에는 해당 환경에서 변경할 항목만 기술하면 된다, 그러나 기본 컴포즈 파일의 구조를 유지해야 도커 컴포즈가 두 정의를 연결 지을 수 있다. **이 예제의 오버라이드 파일은 image 속성값 하나만 변경하는데, 이 속성은 기본 파일상의 위치와 마찬가지로 services 블록의 todo-web 블록 아래에 위치한다.**

도커 컴포즈는 하나 이상의 파일이 인자로 지정됐을 때 이들 파일을 병합한다. 특히 `config` 부명령이 이때 유용한데, 이 부명령은 **입력 파일의 내용을 검증해 내용이 유효한 경우에만 최종 출력을 내놓는다. 이 최종 출력이 실제 반영되는 컴포즈 파일이 되므로 오버라이드 파일을 적용한 결과를 예상할 수 있다.**

```yaml
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose.yml -f ./todo-list/docker-compose-v2.yml config
name: todo-list
services:
  todo-web:
    environment:
      Database:Provider: Sqlite
    image: diamol/ch06-todo-list:v2
    networks:
      app-net: null
    ports:
    - mode: ingress
      target: 80
      protocol: tcp
networks:
  app-net:
    name: todo-list_app-net
hee@yuhuijin-ui-MacBookAir exercises % docker-compose -f ./todo-list/docker-compose-v2.yml -f ./todo-list/docker-compose.yml config
name: todo-list
services:
  todo-web:
    environment:
      Database:Provider: Sqlite
    image: diamol/ch06-todo-list
    networks:
      app-net: null
    ports:
    - mode: ingress
      target: 80
      protocol: tcp
networks:
  app-net:
    name: todo-list_app-net
```

`config` 부명령은 설정 파일의 내용이 유효한지 확인할 뿐 애플리케이션을 실제로 실행하지는 않는다. 대신 기본 파일과 오버라이드 파일이 병합된 컴포즈 파일을 미리 볼 수 있다.

도커 컴포즈가 오버라이드 파일을 병합하는 순서는 인자로 받은 순서를 따른다. 다시 말해, 인자로 지정된 순서가 먼저인 파일이 순서가 나중인 파일보다 우선한다. 파일의 순서를 잘못 나열하면 원치 않은 결과를 얻을 수 있다. `config` 부명령은 병합된 컴포즈 파일의 결과를 미리 알 수 있다는 점에서 유용하다. 병합된 파일의 내용을 보면 모든 속성이 알파벳 순으로 정렬돼 있다. 알파벳 순서로 컴포즈 파일의 구조가 고정되기 때문에 서로 다른 버전을 비교하기에 유리하다.