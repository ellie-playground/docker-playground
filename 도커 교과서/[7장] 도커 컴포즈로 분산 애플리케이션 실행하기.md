# 7.1 도커 컴포즈 파일의 구조

도커 컴포즈 파일은 애플리케이션의 ‘원하는 상태’, 다시 말해 **모든 컴포넌트가 실행 중일 때 어떤 상태여야 하는지를 기술하는 파일**이다. 또한, `docker container run` 명령으로 컨테이너를 실행할 때 지정하는 모든 옵션을 한데 모아 놓은 단순한 형식의 파일이다. 도커 컴포즈 파일을 작성하고 나면 도커 컴포즈 도구를 사용해 애플리케이션을 실행한다. 그러면 도커 컴포즈가 컨테이너, 네트워크, 볼륨 등 필요한 모든 도커 객체를 만들도록 도커 API에 명령을 내린다.

```yaml
version: "3.7"

services:
  todo-web:
    image: diamol/ch06-todo-list
    ports:
      - "8020:80"
    networks:
      - app-net

networks:
  app-net:
    external:
      name: nat
```

이 스크립트의 내용은 도커 네트워크에 도커 컨테이너 하나가 연결된 간단한 애플리케이션을 기술한 것이다. 도커 컴포즈는 사람도 쉽게 읽고 이해할 수 있으며 JSON으로 변환하기도 쉬운 YAML 문법으로 기술된다. YAML 문법은 들여쓰기를 통해 구조를 정의하기 때문에 들여쓰기가 중요하다.

도커 컴포즈를 사용해 이 애플리케이션을 실행하면 컨테이너 하나가 실행돼 스크립트에 정의된 구성을 갖춘다.

애플리케이션을 직접 실행해 보기 전에 스크립트에서 주의 깊게 살펴볼 부분이 두어 곳 있다. `todo-web`이라는 이름의 서비스는 `diamo/ch06-todo-list` 이미지로부터 단일 컨테이너로 실행되며, 이 컨테이너는 ~~호스트 컴퓨터의 80번 포트로~~ 컨테이너 내부 포트 80을 호스트의 8002번 포트로 공개한다. 그리고 `app-net`이라는 이름의 도커 네트워크에 연결된다. 최종적인 결과는 `docker container run -p 8020:80 --name todo-web --network nat diamol/ch06-todo-list` 명령을 실행한 것과 같은 상태가 된다.

서비스 이름 아래로는 속성이 기술된다. 그 내용은 거의 `docker container run` 명령의 옵션과 그 지정값의 쌍 형태다. `image`는 실행할 이미지를 지정하는 필드이고, `ports`는 공개할 포트에 대한 정보, `networks`는 컨테이너가 접속할 도커 네트워크를 정의하는 필드다. 서비스 이름은 컨테이너의 이름이자 도커 네트워크 상에서 다른 컨테이너들이 해당 컨테이너를 식별하기 위한 DNS 네임으로도 쓰인다. 서비스가 구성될 네트워크 이름은 `app-net`이다. 그러나 `networks` 항목을 보면 이 네트워크는 `nat`이라는 이름의 외부 네트워크로 연결된다. `external` 필드의 의미는 `nat` 네트워크가 이미 존재하므로 새로 생성하지 말라는 뜻이다. (docker-compose 실행할 때 만들어지는 것이 아니라 외부에 이미 `nat`이라는 네트워크가 존재하고, 거기에 연결한다.)

도커 컴포즈를 사용하려면 명령행에서 `docker-compose` 명령을 실행하면 된다. `docker-compose`의 사용법은 `docker` 명령과는 다르다. 애플리케이션을 시작하려면 `up` 명령을 실행해야 한다. 그러면 도커 컴포즈가 컴포즈 파일을 체크하고 애플리케이션을 정의된 상태로 실행하기 위해 필요한 요소를 준비하기 시작한다.

```yaml
hee@yuhuijin-ui-MacBookAir docker-playground % docker network create nat
cdedd2080250f79438273ba82178c1199ee4fa35e5adb2c3a6735e0f551d6b81
hee@yuhuijin-ui-MacBookAir docker-playground % cd 도커\ 교과서/practice 
hee@yuhuijin-ui-MacBookAir practice % docker-compose up
version must be a string
hee@yuhuijin-ui-MacBookAir practice % docker-compose up
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 8/8
 ⠿ todo-web Pulled                                                                                                                                                                                                   17.4s
   ⠿ f338bc35613f Pull complete                                                                                                                                                                                      11.2s
   ⠿ 5636d912c69e Pull complete                                                                                                                                                                                      11.9s
   ⠿ 362df8b85fca Pull complete                                                                                                                                                                                      12.0s
   ⠿ 24c3992ceef4 Pull complete                                                                                                                                                                                      13.0s
   ⠿ 546a81dfea0f Pull complete                                                                                                                                                                                      13.3s
   ⠿ 3e6d6e6fdcce Pull complete                                                                                                                                                                                      13.4s
   ⠿ 697b28c7a381 Pull complete                                                                                                                                                                                      13.7s
[+] Running 1/1
 ⠿ Container practice-todo-web-1  Created                                                                                                                                                                             0.3s
Attaching to practice-todo-web-1
practice-todo-web-1  | warn: Microsoft.AspNetCore.DataProtection.Repositories.FileSystemXmlRepository[60]
practice-todo-web-1  |       Storing keys in a directory '/root/.aspnet/DataProtection-Keys' that may not be persisted outside of the container. Protected data will be unavailable when container is destroyed.
practice-todo-web-1  | warn: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[35]
practice-todo-web-1  |       No XML encryptor configured. Key {e21fa875-7b1b-4fe3-bde2-c7eac63548ba} may be persisted to storage in unencrypted form.
practice-todo-web-1  | info: Microsoft.Hosting.Lifetime[0]
practice-todo-web-1  |       Now listening on: http://[::]:80
practice-todo-web-1  | info: Microsoft.Hosting.Lifetime[0]
practice-todo-web-1  |       Application started. Press Ctrl+C to shut down.
practice-todo-web-1  | info: Microsoft.Hosting.Lifetime[0]
practice-todo-web-1  |       Hosting environment: Production
practice-todo-web-1  | info: Microsoft.Hosting.Lifetime[0]
practice-todo-web-1  |       Content root path: /app
```

컴포즈로 애플리케이션을 실행시키기 위해 항상 도커 네트워크가 필요한 것은 아니다. 리눅스 컨테이너를 사용한다면 도커 컴포즈가 네트워크를 대신 관리해주지만, 윈도 컨테이너를 사용한다면 도커를 설치할 때 자동으로 생성되는 기본 네트워크 `nat`을 사용해야 한다.

`docker-compose` 명령을 실행하면 먼저 현재 작업 디렉터리에서 docker-compose.yml 파일을 찾는다. 해당 파일을 발견하면 to-do 애플리케이션의 정의를 읽어 들인다. 현재는 `todo-web` 서비스를 구성하는 컨테이너가 하나도 없으므로 도커 컴포즈가 컨테이너를 하나 실행한다. 이때 출력되는 애플리케이션 로그를 컨테이너별로 정리해서 보여준다. 이 기능은 개발 및 테스트를 수행할 때 매우 도움이 된다.

# 7.2 도커 컴포즈를 사용해 여러 컨테이너로 구성된 애플리케이션 실행하기

```yaml
version: '3.7'

services:

  accesslog:
    image: diamol/ch04-access-log
    networks:
      - app-net

  iotd:
    image: diamol/ch04-image-of-the-day
    ports:
      - "80"
    networks:
      - app-net

  image-gallery:
    image: diamol/ch04-image-gallery
    ports:
      - "8010:80" 
    depends_on:
      - accesslog
      - iotd
    networks:
      - app-net

networks:
  app-net:
    external:
      name: nat
```

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose up --detach
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 0/15
 ⠦ iotd Pulling                                                                                                                                                            3.7s
   ⠙ 83c5cfdaa538 Waiting                                                                                                                                                  0.1s
   ⠙ 96062c0c15f6 Waiting                                                                                                                                                  0.1s
   ⠙ e679cf9f2bb8 Waiting                                                                                                                                                  0.1s
   ⠙ 6b6f36848986 Waiting                                                                                                                                                  0.1s
[+] Running 0/226 Waiting                                       
```

도커 컴포즈를 분리 모드(detached mode)로 애플리케이션을 실행한다. 그림 7-4와 비슷한 내용이 출력될 것이다. 잘 팔펴보면 `image-gallery` 서비스를 시작하기 전에 `accesslog`와 `iotd` 서비스를 먼저 시작하는 것을 알 수 있다. 이것은 컴포즈 파일에 서비스 간의 의존 관계를 설정했기 때문이다.

컴포즈 파일을 사용해 여러 개의 컨테이너로 구성된 애플리케이션을 마치 한 덩어리처럼 다룰 수 있다. API 서비스는 상태가 없으므로 컨테이너를 늘리는 방법으로 스케일 아웃할 수 있다. 웹 컨테이너가 API에 데이터를 요청하면 도커가 여러 개의 API 컨테이너에 이 요청을 고르게 분배해 준다.

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose logs --tail=1 iotd
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
image-of-the-day-iotd-3  | 2026-02-10 14:00:44.729  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.751 seconds (JVM running for 7.86)
image-of-the-day-iotd-1  | 2026-02-10 14:00:44.397  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.566 seconds (JVM running for 7.658)
image-of-the-day-iotd-2  | 2026-02-10 14:00:44.708  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.708 seconds (JVM running for 7.745)
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose logs --tail=1 iotd
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
image-of-the-day-iotd-1  | 2026-02-10 14:00:44.397  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.566 seconds (JVM running for 7.658)
image-of-the-day-iotd-2  | 2026-02-10 14:00:44.708  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.708 seconds (JVM running for 7.745)
image-of-the-day-iotd-3  | 2026-02-10 14:01:10.550  INFO 1 --- [p-nio-80-exec-1] iotd.ImageController                     : Fetched new APOD image from NASA
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose logs --tail=1 iotd
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
image-of-the-day-iotd-2  | 2026-02-10 14:00:44.708  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.708 seconds (JVM running for 7.745)
image-of-the-day-iotd-1  | 2026-02-10 14:00:44.397  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.566 seconds (JVM running for 7.658)
image-of-the-day-iotd-3  | 2026-02-10 14:01:10.550  INFO 1 --- [p-nio-80-exec-1] iotd.ImageController                     : Fetched new APOD image from NASA
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose logs --tail=1 iotd
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
image-of-the-day-iotd-2  | 2026-02-10 14:00:44.708  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.708 seconds (JVM running for 7.745)
image-of-the-day-iotd-3  | 2026-02-10 14:01:10.550  INFO 1 --- [p-nio-80-exec-1] iotd.ImageController                     : Fetched new APOD image from NASA
image-of-the-day-iotd-1  | 2026-02-10 14:00:44.397  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.566 seconds (JVM running for 7.658)
```

명령 실행 후 출력되는 내용을 보면 API 서비스의 컨테이너를 두 개 늘려 애초에 세 배로 만드는 것을 알 수 있다. 사진이 뜨는 웹 페이지를 몇 차례 리프레시 하면 웹 애플리케이션이 API에 데이터를 요청하고, 이들 요청을 늘어난 컨테이너가 고르게 나눠 처리하는데, API 서비스가 요청을 처리할 때마다 남기는 컨테이너 로그로 이를 확인할 수 있다. 도커 컴포즈 명령은 모든 컨테이너 혹은 원하는 컨테이너의 로그만 골라 출력하도록 할 수 있다. `--tail=1` 파라미터는 각 iotd 컨테이너의 마지막 로그를 출력하라는 의미다.

이제 도커 컴포즈가 나를 대신해 컨테이너를 관리해 준다. 하지만 도커 컴포즈를 통해 여전히 전체 애플리케이션을 관리할 수 있다. 컴퓨팅 자원을 절약하기 위해 모든 컨테이너를 중지시킬 수도 있고 다시 컨테이너를 시작해 애플리케이션을 재가동할 수도 있다. 이런 작업은 도커 명령행을 통해서도 할 수 있는 작업이다. 도커 컴포즈는 컨테이너를 관리하는 별도의 명령이지만 내부적으로는 마찬가지로 도커 API를 사용한다. 따라서 도커 컴포즈로 실행한 컨테이너라도 똑같이 도커 명령행으로 관리할 수 있다.

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose stop
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 5/5
 ⠿ Container image-of-the-day-image-gallery-1  Stopped                                                                                                                     0.2s
 ⠿ Container image-of-the-day-iotd-1           Stopped                                                                                                                     0.6s
 ⠿ Container image-of-the-day-iotd-3           Stopped                                                                                                                     0.6s
 ⠿ Container image-of-the-day-iotd-2           Stopped                                                                                                                     0.6s
 ⠿ Container image-of-the-day-accesslog-1      Stopped                                                                                                                    10.2s
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose start
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 5/5
 ⠿ Container image-of-the-day-accesslog-1      Started                                                                                                                     0.5s
 ⠿ Container image-of-the-day-iotd-1           Started                                                                                                                     0.5s
 ⠿ Container image-of-the-day-iotd-2           Started                                                                                                                     0.8s
 ⠿ Container image-of-the-day-iotd-3           Started                                                                                                                     0.8s
 ⠿ Container image-of-the-day-image-gallery-1  Started                                                                                                                     0.7s
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker container ls
CONTAINER ID   IMAGE                          COMMAND                  CREATED          STATUS          PORTS                   NAMES
d5372ddc8977   diamol/ch04-image-gallery      "/web/server"            10 minutes ago   Up 16 seconds   0.0.0.0:8010->80/tcp    image-of-the-day-image-gallery-1
7af55459df92   diamol/ch04-access-log         "docker-entrypoint.s…"   10 minutes ago   Up 17 seconds   80/tcp                  image-of-the-day-accesslog-1
232d35b852d1   diamol/ch04-image-of-the-day   "java -jar /app/iotd…"   10 minutes ago   Up 17 seconds   0.0.0.0:57353->80/tcp   image-of-the-day-iotd-2
53790a484dfb   diamol/ch04-image-of-the-day   "java -jar /app/iotd…"   10 minutes ago   Up 17 seconds   0.0.0.0:57354->80/tcp   image-of-the-day-iotd-3
8f7c0857295f   diamol/ch04-image-of-the-day   "java -jar /app/iotd…"   10 minutes ago   Up 17 seconds   0.0.0.0:57352->80/tcp   image-of-the-day-iotd-1
b9836396bc9f   diamol/ch06-todo-list          "dotnet ToDoList.dll"    32 minutes ago   Up 32 minutes   0.0.0.0:8020->80/tcp    practice-todo-web-1
```

> iotd 컨테이너가 3개인 이유는 과거에 scale=3 상태로 한 번이라도 올라갔고, stop/start 는 그 “개수 상태”를 그대로 유지하기 때문이다.
> 

내용을 보면, 컴포즈로 애플리케이션을 중지할 경우 각 컨테이너의 목록이 표시되지만, 애플리케이션을 재시작할 때는 서비스의 이름만 열거된다. (최신 버전은 아닌 것 같음) 서비스 이름이 열거되는 순서를 잘 보면 의존 관계에 맞춰 실행되는 것을 알 수 있다. 뒤이어 도커 명령행으로 컨테이너 목록을 확인해보면 컨테이너가 생성되고 30분이 지났지만 방금 실행된 것으로 나온다. 이를 보면 **새 컨테이너를 만드는 대신 중지됐던 기존 컨테이너가 다시 실행된 것임을 알 수 있다.**

도커 컴포즈는 다양한 기능이 있지만, 이들 기능을 배우기 전에 알아 두어야 할것들이 있다. **도커 컴포즈는 클라이언트 측에서 동작하는 도구라는 점이다.** 도커 컴포즈 명령을 실행하면 컴포즈 파일의 내용에 따라 도커 API로 지시를 보낸다. 도커 엔진 자체는 컨테이너를 실행할 뿐, 여러 컨테이너가 하나의 애플리케이션으로 동작하는지 여부는 알 수 없다. 이를 아는 것은 YAML로 적힌 컴포즈 파일을 읽어 애플리케이션의 구조를 이해한 컴포즈뿐이다. 그러므로 컴포즈를 사용해 애플리케이션을 관리하려면 컴포즈 파일을 작성하고 이 파일을 읽을 수 있게 해야 한다,

컴포즈 파일을 수정하거나 도커 명령행으로 직접 애플리케이션을 수정하면, 애플리케이션이 컴포즈 파일에 기슬된 구조와 불일치하게 만들 수도 있다. 이 상태에서 도커 컴포즈로 다시 애플리케이션을 관리하려면 비정상적인 동작을 일 수 있다. 우리는 이런 경우를 이미 본 적 있는데, 앞에서 컴포즈 파일 수정 없이 `iotd` 서비스를 컨테이너 세 개로 스케일링 했던 경우가 바로 여기에 해당한다. (근데 난 정상적으로 3개가 만들어졌다.)

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose down
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 5/5
 ⠿ Container image-of-the-day-image-gallery-1  Removed                                                     0.2s
 ⠿ Container image-of-the-day-iotd-1           Removed                                                     0.7s
 ⠿ Container image-of-the-day-accesslog-1      Removed                                                    10.2s
 ⠿ Container image-of-the-day-iotd-2           Removed                                                     0.7s
 ⠿ Container image-of-the-day-iotd-3           Removed                                                     0.6s
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose up -d
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 3/3
 ⠿ Container image-of-the-day-accesslog-1      Started                                                     0.5s
 ⠿ Container image-of-the-day-iotd-1           Started                                                     0.5s
 ⠿ Container image-of-the-day-image-gallery-1  Started                                                     0.9s
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker container ls
CONTAINER ID   IMAGE                          COMMAND                  CREATED          STATUS          PORTS                   NAMES
a707a73f9ab9   diamol/ch04-image-gallery      "/web/server"            14 seconds ago   Up 13 seconds   0.0.0.0:8010->80/tcp    image-of-the-day-image-gallery-1
c95afd6c3b75   diamol/ch04-image-of-the-day   "java -jar /app/iotd…"   14 seconds ago   Up 13 seconds   0.0.0.0:58004->80/tcp   image-of-the-day-iotd-1
7f8009296ea6   diamol/ch04-access-log         "docker-entrypoint.s…"   14 seconds ago   Up 13 seconds   80/tcp                  image-of-the-day-accesslog-1
b9836396bc9f   diamol/ch06-todo-list          "dotnet ToDoList.dll"    11 hours ago     Up 11 hours     0.0.0.0:8020->80/tcp    practice-todo-web-1
```

부명령 `down`은 애플리케이션을 제거하는 명령으로, 애플리케이션이 중지되고 컨테이너를 모두 제거한다. 컴포즈 파일에 포함됐으나 external 플래그가 붙지 않았다면 네트워크와 볼륨도 제거 대상이 된다. 그리고 부명령 `up`은 애플리케이션을 시작하는 명령이다. 하지만 지금은 실행중인 컨테이너가 없으므로 컴포즈 파일에 컴포즈 파일에 정의된 내용대로 모든 서바스를 다시 생성한다. 그러나 컴포즈 파일에는 스케일 아웃에 대한 정의가 없으므로 우리가 세 개로 늘렸던 컨테이너 수가 다시 하나로 돌아간다.

# 7.3 도커 컨테이너 간의 통신

분산 애플리케이션의 모든 구성 요소는 컴포즈가 도커 컨테이너로 실행한다. 그런데 이들 컨테이너는 어떻게 서로 통신할까? 앞서 컨테이너는 별도의 네트워크 공간을 가지는 가상 환경이라고 설명했었다. 컨테이너는 도커 엔진으로부터 부여받은 자신만의 가상 IP 주소를 가지며, 모두 같은 도커 네트워크로 연결돼 이 IP 주소를 통해 서로 통신할 수 있다. 그러나 애플리케이션 생애주기 동안에 컨테이너가 교체되면 IP 주소도 변경된다. IP 주소가 변경돼도 문제가 없도록 도커에서 DNS를 이용해 서비스 디스커버리 기능을 제공한다.

도커에도 DNS 서비스가 내장돼 있다. 컨테이너에서 실행 중인 애플리케이션도 다른 구성요소에 접근하기 위해 이 DNS 서비스를 사용한다. 컨테이너 이름을 도메인 삼아 조회하면 해당 컨테이너의 IP주소를 찾아준다. 이런 방법으로 도커 네트워크 상에 있는 다른 컨테이너의 정보를 사용할 수 있다. 만약 도메인이 가리키는 대상이 컨테이너가 아니면, 도커 엔진을 실행중인 컴퓨터에 요청을 보내 호스트 컴퓨터가 속한 네트워크나 인터넷의 IP 주소를 조회한다.

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose up -d --scale iotd=3  
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 5/5
 ⠿ Container image-of-the-day-iotd-3           Started                                                     0.7s
 ⠿ Container image-of-the-day-iotd-2           Started                                                     0.8s
 ⠿ Container image-of-the-day-iotd-1           Started                                                     0.8s
 ⠿ Container image-of-the-day-accesslog-1      Started                                                     0.7s
 ⠿ Container image-of-the-day-image-gallery-1  Started                                                     1.4s
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker container exec -it image-of-the-day_image-gallery_1 sh
Error: No such container: image-of-the-day_image-gallery_1
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker container exec -it image-of-the-day-image-gallery-1   
"docker container exec" requires at least 2 arguments.
See 'docker container exec --help'.

Usage:  docker container exec [OPTIONS] CONTAINER COMMAND [ARG...]

Run a command in a running container
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker container exec -it image-of-the-day-image-gallery-1 sh
/web # nslookup accesslog
nslookup: can't resolve '(null)': Name does not resolve

Name:      accesslog
Address 1: 172.18.0.6 image-of-the-day-accesslog-1.nat
/web # 
```

`nslookup`은 웹 애플리케이션 컨테이너의 기반 이미지에 들어있는 유틸리티다. 명령의 인자로 도메인을 지정하면 해당 도메인을 DNS 서비스에서 조회하고 그 결과를 출력한다. 

도커 네트워크에 연결된 모든 컨테이너는 이 네트워크 범위에 포함되는 IP 주소를 받는다. 그리고 이 네트워크를 통해 컨테이너 간 통신이 가능하다. DNS 조회를 사용하면 컨테이너가 교체돼 IP 주소가 변경되더라도 항상 새로 만들어진 컨테이너에 접근할 수 있다.

도커 명령행에서 `accesslog` 컨테이너를 직접 삭제하고 도커 컴포즈로 애플리케이션을 재실행해 보면 이를 확인할 수 있다. 도커 컴포즈는 `accesslog` 컨테이너가 없으므로 새로운 컨테이너를 만들어 애플리케이션을 재실행할 것이다. 이 컨테이너는 새로운 IP 주소를 부여받으므로 DNS 조회를 다시 해보면 응답 내용이 달라진 것을 알 수 있다.

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker container rm -f image-of-the-day-accesslog-1
image-of-the-day-accesslog-1
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose up -d --scale iotd=3
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 5/5
 ⠿ Container image-of-the-day-accesslog-1      Started                                                     0.4s
 ⠿ Container image-of-the-day-iotd-2           Running                                                     0.0s
 ⠿ Container image-of-the-day-iotd-1           Running                                                     0.0s
 ⠿ Container image-of-the-day-iotd-3           Running                                                     0.0s
 ⠿ Container image-of-the-day-image-gallery-1  Running                                                     0.0s
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker container exec -it image-of-the-day-image-gallery-1 sh
/web # nslookup accesslog
nslookup: can't resolve '(null)': Name does not resolve

Name:      accesslog
Address 1: 172.18.0.6 image-of-the-day-accesslog-1.nat
/web # nslookup iotd
nslookup: can't resolve '(null)': Name does not resolve

Name:      iotd
Address 1: 172.18.0.4 image-of-the-day-iotd-2.nat
Address 2: 172.18.0.3 image-of-the-day-iotd-3.nat
Address 3: 172.18.0.5 image-of-the-day-iotd-1.nat
/web # 
```

새로 만들어지거나 삭제된 컨테이너가 더 이상 없었으므로 새로 만들어진 `accesslog` 컨테이너에도 기존과 같은 IP 주소 172.18.0.6이 부여됐다. `iotd` API를 대상으로 DNS를 조회해보면 각각의 컨테이너를 가리키는 세 개의 IP 주소가 출력된다.

**하나의 도메인에 대해 DNS 조회 결과에 여러 개의 IP 주소가 나올 수 있다. 도커 컴포즈는 이 점을 활용해 간단한 로드 밸런싱을 구현할 수 있다.** 여러 개의 IP 주소가 담긴 조회 결과를 어떻게 활용할지는 전적으로 애플리케이션이 결정한다. 간단하게 조회 결과의 첫 번째 IP 주소만 사용할 수도 있다. 모든 컨테이너에 고르게 부하가 분배되도록 도커의 DNS 시스템은 조회 결과의 순서를 매번 변화시킨다. `iotd` 서비스를 대상으로 `nslookup` 명령을 여러번 실행하면 이를 확인할 수 있다. 이 방법으로 컨테이너 간의 트래픽을 고르게 분산시킬 수 있다.

# 7.4 도커 컴포즈로 애플리케이션 설정값 지정하기

비밀값은 주로 클러스터 환경에서 쿠버네티스나 도커 스웜같은 컨테이너 플랫폼을 통해 제공된다. 평소에는 클러스터 데이터베이스에 암호화돼 있기 때문에 데이터베이스 패스워드, 인증서, API 키 등 민감한 정보로 구성된 설정값을 전달하는데 적합하다. 도커를 단일 컴퓨터에서 실행하는 상황이라면 비밀값을 보관하는 클러스터 데이터베이스가 없을 것이므로 파일을 통해 비밀값을 전달해도 된다.

이 스크립트는 비밀값 `postgres-connection`의 값을 secret.json 파일에서 읽어 오라는 의미다. 호스트 컴퓨터의 파일이 컨테이너에 영향을 미친다는 점에서 6장에서 배웠던 바인드 마운트와 비슷한 상황이다. 하지만 이 값을 비밀값으로 정의했기 때문에 추후 클러스터 환경에서 암호화된 진짜 비밀값으로 이전할 수 있는 여지를 남겨 둔 것이다.

애플리케이션 설정값을 컴포즈 파일에 정의하면, 같은 도커 이미지라도 다양하게 활용할 수 있고 서로 다른 각 환경에 대한 설정을 명시적으로 정의할 수 있다. 개발 환경과 테스트 환경의 컴포즈 파일을 별도로 작성해 두면 공개하는 포트를 환경에 따라 달리하거나 애플리케이션의 기능을 선택적으로 활성화할 수 있다.

애플리케이션을 실행하면 앞서 본 바와 변함없이 동작하지만, 이제는 데이터가 PostgresSQL 데이터베이스 컨테이너에 저장되며 이 컨테이너를 별도로 관리할 수 있다.

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose up -d
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 3/3
 ⠿ Container image-of-the-day-accesslog-1      Running                                                     0.0s
 ⠿ Container image-of-the-day-iotd-2           Started                                                     1.4s
 ⠿ Container image-of-the-day-image-gallery-1  Started                                                     1.1s
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose ps
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
NAME                               COMMAND                  SERVICE             STATUS              PORTS
image-of-the-day-accesslog-1       "docker-entrypoint.s…"   accesslog           running             80/tcp
image-of-the-day-image-gallery-1   "/web/server"            image-gallery       running             0.0.0.0:8010->80/tcp
image-of-the-day-iotd-2            "java -jar /app/iotd…"   iotd                running             0.0.0.0:58191->80/tcp
```

패키징된 애플리케이션과 설정값을 분리할 수 있다는 것도 도커의 핵심적인 장점 중 하나다. 애플리케이션 이미지는 빌드 파이프라인을 통해 만들어지고 다시 테스트 환경을 거치며 운영 환경에 적합한지 검증된다. 각 환경마다 컴포즈 파일에서 쉽게 정의할 수 있는 환경 변수나 바인드 마운트 설정, 비밀값 등으로 설정값이 적용된다. 이런 방법을 통해 모든 환경에서 동일한 이미지를 사용하므로 개발 환경과 테스트 환경에서 모든 검증을 마친 이미지를 그대로 운영 환경에 투입할 수 있다.

# 7.5 도커 컴포즈도 만능은 아니다

도커 컴포즈는 복잡한 분산 애플리케이션의 설정을 짧고 명료한 포맷의 파일로 나타낼 수 있게 해준다. YAML 형식으로 작성된 컴포즈 파일은 애플리케이션의 배포 요령을 전달하는 목적으로는 워드로 작성된 문서 파일보다 훨씬 낫다.

도커 컨테이너를 본격적으로 사용하려면 도커 컴포즈가 매우 중요한 도구가 될 것이다. 하지만 그 전에 도커 컴포즈의 목적은 무엇이고 어떤 기능과 어떤 제한 사항이 있는지를 잘 이해해야 한다. 컴포즈를 사용하면 애플리케이션을 정의하고 이 정의를 도커 엔진을 실행중인 단일 컴퓨터에 적용할 수 있다. 이 컴퓨터에 실제 활성 상태인 도커 리소스를 파악하고 컴포즈 파일에 기재된 리소스와 비교해 추가로 필요한 리소스를 도커 API를 통해 요청해서 수정하거나 생헝한다.

`docker-compose up` 명령을 실행하기만 하면 내가 정의한 상태대로 애플리케이션을 실행할 수 있다. 하지만 도커 컴포즈가 할 수 있는 일은 여기까지다. 도커 컴포즈는 도커 스웜이나 쿠버네티스같은 완전한 컨테이너 플랫폼이 아니다. 도커 컴포즈에는 이들과 달리 애플리케이션이 지속적으로 정의된 상태를 유지하도록 하는 기능이 없다. 일부 컨테이너가 오류를 일으키거나 강제로 종료되더라도 `docker-compose up` 명령을 실행하지 않는 한 애플리케이션의 상태를 원래대로 되돌릴 수 없다.