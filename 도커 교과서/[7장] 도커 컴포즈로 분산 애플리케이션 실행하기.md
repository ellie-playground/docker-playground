# 7.1 도커 컴포즈 파일의 구조

도커 컴포즈 파일은 애플리케이션의 ‘원하는 상태’, 다시 말해 **모든 컴포넌트가 실행 중일 때 어떤 상태여야 하는지를 기술하는 파일**이다. 또한, `docker container run` 명령으로 컨테이너를 실행할 때 지정하는 모든 옵션을 한데 모아 놓은 단순한 형식의 파일이다. 도커 컴포즈 파일을 작성하고 나면 도커 컴포즈 도구를 사용해 애플리케이션을 실행한다. 그러면 도커 컴포즈가 컨테이너, 네트워크, 볼륨 등 필요한 모든 도커 객체를 만들도록 도커 API에 명령을 내린다.

```yaml
version: "3.7"

services:
  todo-web:
    image: diamol/ch06-todo-list
    ports:
      - "8020:80"
    networks:
      - app-net

networks:
  app-net:
    external:
      name: nat
```

이 스크립트의 내용은 도커 네트워크에 도커 컨테이너 하나가 연결된 간단한 애플리케이션을 기술한 것이다. 도커 컴포즈는 사람도 쉽게 읽고 이해할 수 있으며 JSON으로 변환하기도 쉬운 YAML 문법으로 기술된다. YAML 문법은 들여쓰기를 통해 구조를 정의하기 때문에 들여쓰기가 중요하다.

도커 컴포즈를 사용해 이 애플리케이션을 실행하면 컨테이너 하나가 실행돼 스크립트에 정의된 구성을 갖춘다.

애플리케이션을 직접 실행해 보기 전에 스크립트에서 주의 깊게 살펴볼 부분이 두어 곳 있다. `todo-web`이라는 이름의 서비스는 `diamo/ch06-todo-list` 이미지로부터 단일 컨테이너로 실행되며, 이 컨테이너는 ~~호스트 컴퓨터의 80번 포트로~~ 컨테이너 내부 포트 80을 호스트의 8002번 포트로 공개한다. 그리고 `app-net`이라는 이름의 도커 네트워크에 연결된다. 최종적인 결과는 `docker container run -p 8020:80 --name todo-web --network nat diamol/ch06-todo-list` 명령을 실행한 것과 같은 상태가 된다.

서비스 이름 아래로는 속성이 기술된다. 그 내용은 거의 `docker container run` 명령의 옵션과 그 지정값의 쌍 형태다. `image`는 실행할 이미지를 지정하는 필드이고, `ports`는 공개할 포트에 대한 정보, `networks`는 컨테이너가 접속할 도커 네트워크를 정의하는 필드다. 서비스 이름은 컨테이너의 이름이자 도커 네트워크 상에서 다른 컨테이너들이 해당 컨테이너를 식별하기 위한 DNS 네임으로도 쓰인다. 서비스가 구성될 네트워크 이름은 `app-net`이다. 그러나 `networks` 항목을 보면 이 네트워크는 `nat`이라는 이름의 외부 네트워크로 연결된다. `external` 필드의 의미는 `nat` 네트워크가 이미 존재하므로 새로 생성하지 말라는 뜻이다. (docker-compose 실행할 때 만들어지는 것이 아니라 외부에 이미 `nat`이라는 네트워크가 존재하고, 거기에 연결한다.)

도커 컴포즈를 사용하려면 명령행에서 `docker-compose` 명령을 실행하면 된다. `docker-compose`의 사용법은 `docker` 명령과는 다르다. 애플리케이션을 시작하려면 `up` 명령을 실행해야 한다. 그러면 도커 컴포즈가 컴포즈 파일을 체크하고 애플리케이션을 정의된 상태로 실행하기 위해 필요한 요소를 준비하기 시작한다.

```yaml
hee@yuhuijin-ui-MacBookAir docker-playground % docker network create nat
cdedd2080250f79438273ba82178c1199ee4fa35e5adb2c3a6735e0f551d6b81
hee@yuhuijin-ui-MacBookAir docker-playground % cd 도커\ 교과서/practice 
hee@yuhuijin-ui-MacBookAir practice % docker-compose up
version must be a string
hee@yuhuijin-ui-MacBookAir practice % docker-compose up
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 8/8
 ⠿ todo-web Pulled                                                                                                                                                                                                   17.4s
   ⠿ f338bc35613f Pull complete                                                                                                                                                                                      11.2s
   ⠿ 5636d912c69e Pull complete                                                                                                                                                                                      11.9s
   ⠿ 362df8b85fca Pull complete                                                                                                                                                                                      12.0s
   ⠿ 24c3992ceef4 Pull complete                                                                                                                                                                                      13.0s
   ⠿ 546a81dfea0f Pull complete                                                                                                                                                                                      13.3s
   ⠿ 3e6d6e6fdcce Pull complete                                                                                                                                                                                      13.4s
   ⠿ 697b28c7a381 Pull complete                                                                                                                                                                                      13.7s
[+] Running 1/1
 ⠿ Container practice-todo-web-1  Created                                                                                                                                                                             0.3s
Attaching to practice-todo-web-1
practice-todo-web-1  | warn: Microsoft.AspNetCore.DataProtection.Repositories.FileSystemXmlRepository[60]
practice-todo-web-1  |       Storing keys in a directory '/root/.aspnet/DataProtection-Keys' that may not be persisted outside of the container. Protected data will be unavailable when container is destroyed.
practice-todo-web-1  | warn: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[35]
practice-todo-web-1  |       No XML encryptor configured. Key {e21fa875-7b1b-4fe3-bde2-c7eac63548ba} may be persisted to storage in unencrypted form.
practice-todo-web-1  | info: Microsoft.Hosting.Lifetime[0]
practice-todo-web-1  |       Now listening on: http://[::]:80
practice-todo-web-1  | info: Microsoft.Hosting.Lifetime[0]
practice-todo-web-1  |       Application started. Press Ctrl+C to shut down.
practice-todo-web-1  | info: Microsoft.Hosting.Lifetime[0]
practice-todo-web-1  |       Hosting environment: Production
practice-todo-web-1  | info: Microsoft.Hosting.Lifetime[0]
practice-todo-web-1  |       Content root path: /app
```

컴포즈로 애플리케이션을 실행시키기 위해 항상 도커 네트워크가 필요한 것은 아니다. 리눅스 컨테이너를 사용한다면 도커 컴포즈가 네트워크를 대신 관리해주지만, 윈도 컨테이너를 사용한다면 도커를 설치할 때 자동으로 생성되는 기본 네트워크 `nat`을 사용해야 한다.

`docker-compose` 명령을 실행하면 먼저 현재 작업 디렉터리에서 docker-compose.yml 파일을 찾는다. 해당 파일을 발견하면 to-do 애플리케이션의 정의를 읽어 들인다. 현재는 `todo-web` 서비스를 구성하는 컨테이너가 하나도 없으므로 도커 컴포즈가 컨테이너를 하나 실행한다. 이때 출력되는 애플리케이션 로그를 컨테이너별로 정리해서 보여준다. 이 기능은 개발 및 테스트를 수행할 때 매우 도움이 된다.

# 7.2 도커 컴포즈를 사용해 여러 컨테이너로 구성된 애플리케이션 실행하기

```yaml
version: '3.7'

services:

  accesslog:
    image: diamol/ch04-access-log
    networks:
      - app-net

  iotd:
    image: diamol/ch04-image-of-the-day
    ports:
      - "80"
    networks:
      - app-net

  image-gallery:
    image: diamol/ch04-image-gallery
    ports:
      - "8010:80" 
    depends_on:
      - accesslog
      - iotd
    networks:
      - app-net

networks:
  app-net:
    external:
      name: nat
```

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose up --detach
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 0/15
 ⠦ iotd Pulling                                                                                                                                                            3.7s
   ⠙ 83c5cfdaa538 Waiting                                                                                                                                                  0.1s
   ⠙ 96062c0c15f6 Waiting                                                                                                                                                  0.1s
   ⠙ e679cf9f2bb8 Waiting                                                                                                                                                  0.1s
   ⠙ 6b6f36848986 Waiting                                                                                                                                                  0.1s
[+] Running 0/226 Waiting                                       
```

도커 컴포즈를 분리 모드(detached mode)로 애플리케이션을 실행한다. 그림 7-4와 비슷한 내용이 출력될 것이다. 잘 팔펴보면 `image-gallery` 서비스를 시작하기 전에 `accesslog`와 `iotd` 서비스를 먼저 시작하는 것을 알 수 있다. 이것은 컴포즈 파일에 서비스 간의 의존 관계를 설정했기 때문이다.

컴포즈 파일을 사용해 여러 개의 컨테이너로 구성된 애플리케이션을 마치 한 덩어리처럼 다룰 수 있다. API 서비스는 상태가 없으므로 컨테이너를 늘리는 방법으로 스케일 아웃할 수 있다. 웹 컨테이너가 API에 데이터를 요청하면 도커가 여러 개의 API 컨테이너에 이 요청을 고르게 분배해 준다.

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose logs --tail=1 iotd
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
image-of-the-day-iotd-3  | 2026-02-10 14:00:44.729  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.751 seconds (JVM running for 7.86)
image-of-the-day-iotd-1  | 2026-02-10 14:00:44.397  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.566 seconds (JVM running for 7.658)
image-of-the-day-iotd-2  | 2026-02-10 14:00:44.708  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.708 seconds (JVM running for 7.745)
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose logs --tail=1 iotd
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
image-of-the-day-iotd-1  | 2026-02-10 14:00:44.397  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.566 seconds (JVM running for 7.658)
image-of-the-day-iotd-2  | 2026-02-10 14:00:44.708  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.708 seconds (JVM running for 7.745)
image-of-the-day-iotd-3  | 2026-02-10 14:01:10.550  INFO 1 --- [p-nio-80-exec-1] iotd.ImageController                     : Fetched new APOD image from NASA
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose logs --tail=1 iotd
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
image-of-the-day-iotd-2  | 2026-02-10 14:00:44.708  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.708 seconds (JVM running for 7.745)
image-of-the-day-iotd-1  | 2026-02-10 14:00:44.397  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.566 seconds (JVM running for 7.658)
image-of-the-day-iotd-3  | 2026-02-10 14:01:10.550  INFO 1 --- [p-nio-80-exec-1] iotd.ImageController                     : Fetched new APOD image from NASA
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose logs --tail=1 iotd
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
image-of-the-day-iotd-2  | 2026-02-10 14:00:44.708  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.708 seconds (JVM running for 7.745)
image-of-the-day-iotd-3  | 2026-02-10 14:01:10.550  INFO 1 --- [p-nio-80-exec-1] iotd.ImageController                     : Fetched new APOD image from NASA
image-of-the-day-iotd-1  | 2026-02-10 14:00:44.397  INFO 1 --- [           main] iotd.Application                         : Started Application in 6.566 seconds (JVM running for 7.658)
```

명령 실행 후 출력되는 내용을 보면 API 서비스의 컨테이너를 두 개 늘려 애초에 세 배로 만드는 것을 알 수 있다. 사진이 뜨는 웹 페이지를 몇 차례 리프레시 하면 웹 애플리케이션이 API에 데이터를 요청하고, 이들 요청을 늘어난 컨테이너가 고르게 나눠 처리하는데, API 서비스가 요청을 처리할 때마다 남기는 컨테이너 로그로 이를 확인할 수 있다. 도커 컴포즈 명령은 모든 컨테이너 혹은 원하는 컨테이너의 로그만 골라 출력하도록 할 수 있다. `--tail=1` 파라미터는 각 iotd 컨테이너의 마지막 로그를 출력하라는 의미다.

이제 도커 컴포즈가 나를 대신해 컨테이너를 관리해 준다. 하지만 도커 컴포즈를 통해 여전히 전체 애플리케이션을 관리할 수 있다. 컴퓨팅 자원을 절약하기 위해 모든 컨테이너를 중지시킬 수도 있고 다시 컨테이너를 시작해 애플리케이션을 재가동할 수도 있다. 이런 작업은 도커 명령행을 통해서도 할 수 있는 작업이다. 도커 컴포즈는 컨테이너를 관리하는 별도의 명령이지만 내부적으로는 마찬가지로 도커 API를 사용한다. 따라서 도커 컴포즈로 실행한 컨테이너라도 똑같이 도커 명령행으로 관리할 수 있다.

```yaml
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose stop
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 5/5
 ⠿ Container image-of-the-day-image-gallery-1  Stopped                                                                                                                     0.2s
 ⠿ Container image-of-the-day-iotd-1           Stopped                                                                                                                     0.6s
 ⠿ Container image-of-the-day-iotd-3           Stopped                                                                                                                     0.6s
 ⠿ Container image-of-the-day-iotd-2           Stopped                                                                                                                     0.6s
 ⠿ Container image-of-the-day-accesslog-1      Stopped                                                                                                                    10.2s
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker-compose start
WARN[0000] network app-net: network.external.name is deprecated in favor of network.name 
[+] Running 5/5
 ⠿ Container image-of-the-day-accesslog-1      Started                                                                                                                     0.5s
 ⠿ Container image-of-the-day-iotd-1           Started                                                                                                                     0.5s
 ⠿ Container image-of-the-day-iotd-2           Started                                                                                                                     0.8s
 ⠿ Container image-of-the-day-iotd-3           Started                                                                                                                     0.8s
 ⠿ Container image-of-the-day-image-gallery-1  Started                                                                                                                     0.7s
hee@yuhuijin-ui-MacBookAir image-of-the-day % docker container ls
CONTAINER ID   IMAGE                          COMMAND                  CREATED          STATUS          PORTS                   NAMES
d5372ddc8977   diamol/ch04-image-gallery      "/web/server"            10 minutes ago   Up 16 seconds   0.0.0.0:8010->80/tcp    image-of-the-day-image-gallery-1
7af55459df92   diamol/ch04-access-log         "docker-entrypoint.s…"   10 minutes ago   Up 17 seconds   80/tcp                  image-of-the-day-accesslog-1
232d35b852d1   diamol/ch04-image-of-the-day   "java -jar /app/iotd…"   10 minutes ago   Up 17 seconds   0.0.0.0:57353->80/tcp   image-of-the-day-iotd-2
53790a484dfb   diamol/ch04-image-of-the-day   "java -jar /app/iotd…"   10 minutes ago   Up 17 seconds   0.0.0.0:57354->80/tcp   image-of-the-day-iotd-3
8f7c0857295f   diamol/ch04-image-of-the-day   "java -jar /app/iotd…"   10 minutes ago   Up 17 seconds   0.0.0.0:57352->80/tcp   image-of-the-day-iotd-1
b9836396bc9f   diamol/ch06-todo-list          "dotnet ToDoList.dll"    32 minutes ago   Up 32 minutes   0.0.0.0:8020->80/tcp    practice-todo-web-1
```

iotd 컨테이너가 3개인 이유는 과거에 scale=3 상태로 한 번이라도 올라갔고, stop/start 는 그 “개수 상태”를 그대로 유지하기 때문이다.

내용을 보면, 컴포즈로 애플리케이션을 중지할 경우 각 컨테이너의 목록이 표시되지만, 애플리케이션을 재시작할 때는 서비스의 이름만 열거된다. (최신 버전은 아닌 것 같음) 서비스 이름이 열거되는 순서를 잘 보면 의존 관계에 맞춰 실행되는 것을 알 수 있다. 뒤이어 도커 명령행으로 컨테이너 목록을 확인해보면 컨테이너가 생성되고 30분이 지났지만 방금 실행된 것으로 나온다. 이를 보면 **새 컨테이너를 만드는 대신 중지됐던 기존 컨테이너가 다시 실행된 것임을 알 수 있다.**