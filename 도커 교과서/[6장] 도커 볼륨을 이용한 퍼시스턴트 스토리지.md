# 6.1 컨테이너 속 데이터가 사라지는 이유

도커 컨테이너에도 단일 드라이브로 된 파일 시스템이 있다. 이 파일 시스템의 내용은 이미지 속 파일로부터 만들어진다. Dockerfile 스크립트에서 `COPY` 인스트럭션을 사용해 파일을 이미지로 복사하면, 이 이미지로 실행한 컨테이너에도 같은 경로에 복사된 파일이 있다. 그리고 앞서 도커 이미지는 여러 개의 레이어 형태로 저장된다고 설명했었다. 컨테이너의 디스크 역시 이 이미지 레이어를 순서대로 합쳐 만든 가상 파일 시스템이다.

모든 컨테이너는 독립된 파일 시스템을 갖는다. 같은 이미지에서 실행한 여러 개의 컨테이너는 처음에는 디스크의 내용이 모두 같지만, 그 중 한 컨테이너에서 애플리케이션이 파일을 수정해도 다른 컨테이너나 이미지는 영향을 받지 않는다.

[docker RW layer / overlay network swarm network](https://velog.io/@agnusdei1207/docker-RW-layer)

```docker
sh-3.2# docker container run --name rn1 diamol/ch06-random-number
Unable to find image 'diamol/ch06-random-number:latest' locally
latest: Pulling from diamol/ch06-random-number
941f399634ec: Already exists 
a9688c0f061a: Pull complete 
353e82f8473e: Pull complete 
d03cc88bf2c6: Pull complete 
Digest: sha256:aea876d5ff413b6e5f2d2bc13f0c70b562e7a2facc215798f22ca5344026e2ce
Status: Downloaded newer image for diamol/ch06-random-number:latest
sh-3.2# docker container run --name rn2 diamol/ch06-random-number
sh-3.2# docker ps
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
sh-3.2# docker ps -a
CONTAINER ID   IMAGE                       COMMAND                  CREATED          STATUS                      PORTS     NAMES
c87bfc9bb65e   diamol/ch06-random-number   "/bin/sh -c ./random…"   11 seconds ago   Exited (0) 10 seconds ago             rn2
1ed667b764d8   diamol/ch06-random-number   "/bin/sh -c ./random…"   16 seconds ago   Exited (0) 16 seconds ago             rn1
```

컨테이너를 실행하면 텍스트 파일에 무작위 숫자를 쓰는 스크립트가 실행된다. 그리고 컨테이너를 종료하면 Exited 상태가 된다. 이 두 컨테이너는 같은 이미지로부터 실행됐으나 파일 시스템의 내용은 서로 다르다. 2장에서 컨테이너를 종료해도 파일 시스템은 삭제되지 않는다고 배웠다. 그러므로 컨테이너의 파일과 디렉터리는 그대로 남아 있을 것이다.

`docker container cp` 명령을 사용해 컨테이너와 로컬 컴퓨터 간에 파일을 복사할 수 있다. 이 명령에 파일의 경로와 이름을 지정하면 무작위 숫자가 쓰인 텍스트 파일을 로컬 컴퓨터로 복사해 파일의 내용을 확인할 수 있다.

```docker
hee@yuhuijin-ui-MacBookAir practice % docker container cp rn1:/random/number.txt number1.txt
hee@yuhuijin-ui-MacBookAir practice % docker container cp rn2:/random/number.txt number2.txt
hee@yuhuijin-ui-MacBookAir practice % cat number1.txt 
2184
hee@yuhuijin-ui-MacBookAir practice % cat number2.txt
25785
```

두 컨테이너는 모두 같은 경로에 파일을 생성했다. 이 파일을 로컬 컴퓨터로 복사해서 내용을 확인해보니 두 파일의 내용이 서로 달랐다. 이로써 **컨테이너의 파일 시스템이 서로 독립적임을 알 수 있었다.** 여기서는 단지 파일 하나의 내용이지만, 같은 데이터베이스 엔진 이미지로 실행된 두 컨테이너가 서로 전혀 다른 데이터를 담을 수도 있는 것이다.

컨테이너의 파일 시스템은 단일 디스크(리눅스 컨테이너는 /dev/sda1, 윈도는 C:\)다. 그러나 이 디스크는 도커가 여러 출처로부터 합쳐 만들고 컨테이너에 전달한 가상 파일 시스템이다. 이 출처는 기본적으로 이미지 레이어와 컨테이너의 기록 가능 레이어로 구성되는데, 이미지 레이어는 모든 컨테이너가 공유하지만 기록 가능 레이어는 컨테이너마다 다르다.

그림 6-2에서 알 수 있는 두 가지 중요한 사실이 있다. 모든 컨테이너가 공유하는 이미지 레이어는 읽기 전용이고, 각 컨테이너가 따로 갖는 기록 가능 레이어(RW 레이어)는 컨테이너와 같은 생애주기를 갖는다. **이미지 레이어는 이미지를 내려받은 순간부터 삭제할 때까지 로컬 컴퓨터의 이미지 레이어에 존재한다. 그러나 컨테이너의 쓰기 가능 레이어는 컨테이너를 실행할 때 생성되며 컨테이너를 삭제할 때 함께 삭제된다.**(컨테이너를 종료하는 것만으로는 컨테이너가 삭제되지 않는다. 그래서 종료된 컨테이너의 데이터도 그대로 남아있는 것이다.)

기록 가능 레이어를 새 파일을 만드는 데만 사용하는 것은 아니다. 기존 이미지 레이어에 있는 파일을 수정할 수도 있다. 그러나 조금 전에 이미지 레이어는 읽기 전용이라고 하지 않았나? 여기에 바로 비밀이 있다. 도커는 기록중 복사(Copy-On-Write) 라는 방법을 사용해 읽기 전용 레이어의 파일을 수정할 수 있다. 컨테이너에서 이미지 레이어에 포함된 파일을 수정하려 하면, 먼저 도커가 이 파일을 쓰기 가능 레이어로 복사해 온 다음 쓰기 가능 레이어에서 파일을 수정한다.

```docker
sh-3.2# docker container run --name f1 diamol/ch06-file-display
Unable to find image 'diamol/ch06-file-display:latest' locally
latest: Pulling from diamol/ch06-file-display
941f399634ec: Already exists 
716aca3e500c: Already exists 
2755907779b3: Pull complete 
Digest: sha256:98c52776132a793d22524080e16a37db52de6a72dc5687cd5f6ae371d14dad12
Status: Downloaded newer image for diamol/ch06-file-display:latest
https://www.manning.com/books/learn-docker-in-a-month-of-lunches
sh-3.2# echo "http://eltonstoneman.com" > url.txt
sh-3.2# docker container cp url.txt f1:/input.txt
sh-3.2# docker container start --attach f1
http://eltonstoneman.com
```

이번에는 로컬 컴퓨터에서 컨테이너로 파일을 복사했다. 이 파일이 컨테이너가 내용을 출력하는 파일이다. 컨테이너를 재시작해 보면 똑같은 스크립트가 실행되며 파일의 내용을 출력하지만, 파일의 내용이 달라졌다.

컨테이너 속 파일을 수정하면 컨테이너의 동작에 영향을 미친다. 그러나 이미지를 공유하는 다른 컨테이너나 이미지는 영향을 받지 않는다. **수정된 파일은 해당 컨테이너의 기록 가능 레이어에만 존재하기 때문이다.** 새로운 컨테이너는 이미지로부터 받은 최초의 내용을 담은 파일 시스템을 가지며, f1 컨테이너가 삭제되면 수정된 파일도 사라진다.